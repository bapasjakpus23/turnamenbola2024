<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <!-- Bootstrap CSS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&family=Playwrite+DE+Grund:wght@100..400&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">

        <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300..700&family=Nunito+Sans:ital,opsz,wght@0,6..12,200..1000;1,6..12,200..1000&family=PT+Sans:ital,wght@0,400;0,700;1,400;1,700&family=Playwrite+DE+Grund:wght@100..400&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
        

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  
    <?!= include("index-css"); ?>
  </head>





  <body>

<nav class="navbar navbar-expand bg-primary fixed-top">
    <a class="navbar-brand" href="#">
        <i class="fas fa-futbol" style="margin-left:10px;"></i> <!-- Football Icon -->
    </a>
    <div class="d-flex flex-row" id="navbarNav">
        <ul class="navbar-nav">
  
            <li class="nav-item">
                <a class="nav-link disabled" href="#" style="color:white;" id="akun">  </a>
            </li>
        </ul>
    </div>
</nav>

<div class="container">


     <div class="row mb-2 mt-5">
              <div class="col-md-12 d-flex justify-content-end align-items-center">
                  <br> <br> <br> <br> <br> 
                  <h2 class="text-center me-3 mb-0 login-text"  >Login Admin</h2>
                  <a style="display:none" id="myid" href="<?= myURL(); ?>" target="_top">Link</a>
                  <form class="d-flex align-items-end">
                      <div class="me-3">
                          <label for="uid" class="form-label sr-only">Username</label>
                          <input type="text" class="form-control" id="uid" name="username" placeholder="Username" required onchange="ClearText()">
                      </div>
                      <div class="me-3 position-relative">
                          <label for="pass" class="form-label sr-only">Password</label>
                          <input type="password" class="form-control" id="pass" name="password" placeholder="Password" required onchange="ClearText()">

                        <button type="button" class="btn btn-sm position-absolute top-50 end-0 translate-middle-y" id="togglePassword" onclick="eye()">
                            <i class="fas fa-eye" id="eyeIcon"></i>
                        </button>
  
                      </div>
                      <button type="button" class="btn btn-primary" id="loginBtn" onclick="login()">
                          Login
                          <span id="spinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
                      </button>
                  </form>
              </div>
          </div>
          <div style="height:50px;">
              <div id="RetMsg" class="alert alert-danger" style="display:none" role="alert"></div>
          </div>
</div>




    <div class="container mt-5 mb-5">
      <h1 class="text-center h2 mb-4">Football Team Registration</h1>


      <form id="teamForm" class="mb-4 mt-3">
        <div class="mb-3">
          <label for="teamName" class="form-label">Nama Tim:</label>
          <input type="text" class="form-control" id="teamName" required>
        </div>
        <div class="mb-3">
          <label for="imageUploadTim" class="form-label">Upload Logo Tim:</label>
          <input type="file" class="form-control" id="imageUploadTim" accept=".jpg, .jpeg, .png" required>
      </div>
        <button type="button" class="btn btn-sm btn-primary" id="registerTeamBtn" onclick="registerTeam()">Register Team
          <span id="spinner3" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
        </button>
      </form>

      <div> <img src="" alt="Team Logo" id="logoTim" style="max-width: 100%; height: auto;"></div>



      
      <form id="playerForm" class="mb-4">
        <div class="mb-3">
          <label for="playerName" class="form-label">Nama Pemain:</label>
          <input type="text" class="form-control" id="playerName" required>
        </div>
        <div class="mb-3">
          <label for="noKtp" class="form-label">No KTP:</label>
          <input type="number" class="form-control" id="noKtp" required>
        </div>
        <div class="mb-3">
          <label for="posisi" class="form-label">Posisi:</label>
          <input type="text" class="form-control" id="posisi" required>
        </div>    
        <div class="mb-3">
          <label for="noPunggung" class="form-label">No Punggung:</label>
          <input type="number" class="form-control" id="noPunggung" required>
        </div>               
        <div class="mb-3">
          <label for="teamId" class="form-label">Nama Tim:</label>
          <input type="text" class="form-control" id="teamId" required disabled  >
        </div>
        <div class="mb-3">
          <label for="imageUpload" class="form-label">Upload Image:</label>
          <input type="file" class="form-control" id="imageUpload" accept=".jpg, .jpeg, .png" required>
      </div>
        <div class="mb-3" style="display: none;">
          <label for="register" class="form-label">Register:</label>
          <input type="text" value="register" class="form-control" id="register" required>
        </div>
        
        
        <button type="button" class="btn btn-sm btn-success" id="registerPemainBtn" onclick="registerPlayer()">Register Player
           <span id="spinner2" class="spinner-border spinner-border-sm" role="status" aria-hidden="true" style="display: none;"></span>
        </button>
      </form>

      <button type="button" class="btn btn-info" onclick="fetchPlayers()">Fetch Players</button>
      <h5 class="text-center h5 mb-5 fw-bold">Nama Pemain yang terdaftar</h5>
<div></div>
        <div class="mt-4">
          <table class="table table-bordered table-success table-striped " id="playerTable">
            <thead>
              <tr>
                <th style="width:5px;" class="text-center align-top">No</th>
                <th style="width:10px;" class="text-center align-top">Posisi</th> 
                <th style="width:150px;" class="align-top">Nama Pemain</th>    
                <th style="width:5px;" class="text-center align-top">No Punggung</th>
                <th style="width:100px;" class="text-center align-top">Image</th>
                <th style="width:100px;" class="text-center align-top">Status</th>

                </tr>
            </thead>
            <tbody id="playerList">
              <tr>
                <td colspan="3">Loading...</td>
              </tr>
            </tbody>
          </table>
          <br> <br> <br> <br> 
        </div>

       
        
        <h5 class="text-center h5 mb-5 fw-bold">Nama Pemain yang diturunkan</h5>
        <div></div>


      <div class="mt-3">
        <table class="table table-bordered table-success table-striped " id="playerTableMatch">
          <thead>
              <tr>
                <th style="width:5px;" class="text-center align-top">No</th>
                <th style="width:10px;" class="text-center align-top">Posisi</th> 
                <th style="width:200px;" class="align-top">Nama Pemain</th>    
                <th style="width:5px;" class="text-center align-top">No Punggung</th>
                <th style="width:100px;" class="text-center align-top">Status</th>
              </tr>
          </thead>
          <tbody id="playerListMatcday">
            <tr>
              <td colspan="3">Loading...</td>
            </tr>
          </tbody>
        </table>
        <br><br><br><br>
      </div>




     </div>   

    <script>
      $(document).ready(function() {
        fetchPlayers();
        getPlayersByMatchday();
        akun();    
        fetchTim();    
        fetchLogo();
         

        function getRegistrationDates() {          
            google.script.run.withSuccessHandler(function() {             
            }).getRegistrationDates();
          }        
        
      });

      function akun() {
          google.script.run.withSuccessHandler(function(email) {
              document.getElementById('akun').innerText = `Anda Masuk Sebagai: ${email}`; 
            }).akun();
          }

          function fetchTim() {
          google.script.run.withSuccessHandler(function(namaTim) {
              document.getElementById('teamId').value = namaTim;       
          }).tim();
      } 

      function fetchLogo() {
          google.script.run.withSuccessHandler(function(logoTim) {
              document.getElementById('logoTim').src = logoTim;       
          }).logo_tim();
      } 


 

function registerTeam() {
  const teamName = $('#teamName').val();  
  const imageFile = document.getElementById('imageUploadTim').files[0];
  const spinner3 = $('#spinner3');
  const registerTeamBtn = $('#registerTeamBtn') ;  
  
  spinner3.show();  
  registerTeamBtn.prop('disabled', true); 


  if(imageFile) {

    const reader = new FileReader();
        reader.onload = function(event) {
            const imageData = event.target.result.split(',')[1]; // Get base64 string
            google.script.run.withSuccessHandler(function() {
              fetchTim()
              alert('Pendaftaran tim berhasil!');
                spinner3.hide(); // Hide spinner on success
                registerTeamBtn.prop('disabled', false); // Enable button on success
            }).withFailureHandler(function(error) {
                alert(error.message);
                spinner3.hide(); // Hide spinner on failure
                registerTeamBtn.prop('disabled', false); // Enable button on failure
            }).registerTeam(teamName, imageData);
        };
        reader.readAsDataURL(imageFile);
  } else {

    google.script.run.withSuccessHandler(function() {
              fetchTim()
              alert('Pendaftaran tim berhasil!');
                spinner2.hide(); // Hide spinner on success
                registerTeamBtn.prop('disabled', false); // Enable button on success
            }).withFailureHandler(function(error) {
                alert(error.message);
                spinner2.hide(); // Hide spinner on failure
                registerTeamBtn.prop('disabled', false); // Enable button on failure
            }).registerTeam(teamName, imageData);
        ;
      }
}



function registerPlayer() {
    const playerName = $('#playerName').val();
    const noKtp = $('#noKtp').val();
    const posisi = $('#posisi').val();
    const noPunggung = $('#noPunggung').val();
    const teamId = $('#teamId').val();
    const register = $('#register').val();
    const imageFile = document.getElementById('imageUpload').files[0];
    const spinner2 = $('#spinner2');
    const registerPemainBtn = $('#registerPemainBtn');

    spinner2.show();
    registerPemainBtn.prop('disabled', true);

    // Check if an image file is selected
    if (imageFile) {
        const reader = new FileReader();
        reader.onload = function(event) {
            const imageData = event.target.result.split(',')[1]; // Get base64 string
            google.script.run.withSuccessHandler(function() {
                alert('Pendaftaran pemain berhasil!');
                fetchPlayers();
                spinner2.hide(); // Hide spinner on success
                registerPemainBtn.prop('disabled', false); // Enable button on success
            }).withFailureHandler(function(error) {
                alert(error.message);
                spinner2.hide(); // Hide spinner on failure
                registerPemainBtn.prop('disabled', false); // Enable button on failure
            }).registerPlayer(playerName, noKtp, posisi, noPunggung, teamId, register, imageData);
        };
        reader.readAsDataURL(imageFile);
    } else {
        // If no image is uploaded, call the server function with null or empty string for imageData
        google.script.run.withSuccessHandler(function() {
            alert('Pendaftaran pemain berhasil!');
            fetchPlayers();
            spinner2.hide(); // Hide spinner on success
            registerPemainBtn.prop('disabled', false); // Enable button on success
        }).withFailureHandler(function(error) {
            alert(error.message);
            spinner2.hide(); // Hide spinner on failure
            registerPemainBtn.prop('disabled', false); // Enable button on failure
        }).registerPlayer(playerName, noKtp, posisi, noPunggung, teamId, register, null); // Pass null for imageData
    }
}

 

function fetchPlayers() {
  google.script.run.withSuccessHandler(function(players) {
    const playerListBody = $('#playerList');
    playerListBody.empty(); // Clear previous results

    google.script.run.withSuccessHandler(function(dates) {
      const startDate = new Date(dates.startDate);
      const endDate = new Date(dates.endDate);
      const currentDate = new Date();
      let rowNumber = 1; // Initialize row number

      if (players.length > 0) {
        players.forEach(function(player) {
          const playerRow = $('<tr></tr>');
          playerRow.append($('<td style="text-align:center;"></td>').text(rowNumber)); // Add row number
          playerRow.append($('<td style="text-align:center;"></td>').text(player[4])); // Position          
          playerRow.append($('<td></td>').text(player[2])); // Player Name  
          playerRow.append($('<td style="text-align:center;"></td>').text(player[5])); // Jersey Number
          playerRow.append($('<td></td>').append($('<img>').attr('src', player[9]).css('width', '50px').css('height', 'auto'))); // Display image
          
          // Create a dropdown for status
          const statusDropdown = $('<select class="form-select  custom-select"  onchange="updatePlayerStatus(' + player[0] + ', this.value)"></select>');
          const statuses = ["Register", "Line Up", "Substitute"];
          
          // Populate dropdown with statuses and set the selected value from Column G
          statuses.forEach(function(status) {
            const option = $('<option></option>').text(status).val(status);
            if (status === player[7]) {  // Assuming player[6] corresponds to Column G
              option.attr('selected', 'selected');
            }
            statusDropdown.append(option);
          });

          // Enable or disable the dropdown based on the date range
          if (currentDate >= startDate && currentDate <= endDate) {
            statusDropdown.prop('disabled', false);
          } else {
            statusDropdown.prop('disabled', true);
          }

          playerRow.append($('<td></td>').append(statusDropdown)); // Append dropdown to the row
          playerListBody.append(playerRow);
          rowNumber++; // Increment row number
        });
      } else {
        playerListBody.append('<tr><td colspan="5">Tidak ada pemain ditemukan untuk akun ini.</td></tr>');
      }
    }).withFailureHandler(function(error) {
      console.error("Error fetching registration dates: " + error.message);
      playerListBody.append('<tr><td colspan="5">Error fetching registration dates.</td></tr>');
    }).getRegistrationDates(); // Fetch registration dates from the server
  }).withFailureHandler(function(error) {
    console.error("Error fetching players: " + error.message);
  }).fetchPlayers();
}


function getPlayersByMatchday() {
  google.script.run.withSuccessHandler(function(players) {
    const playerListBody = $('#playerListMatcday');
    playerListBody.empty(); // Clear previous results
     let rowNumber = 1; // Initialize row number
    if (players.length > 0) {
      players.forEach(function(player) {
        const playerRow = $('<tr></tr>');
        playerRow.append($('<td style="text-align:center;"></td>').text(rowNumber)); // Player ID at index 0
        playerRow.append($('<td style="text-align:center;"></td>').text(player[4])); // Posisi
        playerRow.append($('<td></td>').text(player[2])); // Player Name  
        playerRow.append($('<td style="text-align:center;"></td>').text(player[5])); // No Punggung
        playerRow.append($('<td style="text-align:center;"></td>').text(player[7])); // Status at index 3
        playerListBody.append(playerRow);
         rowNumber++
      });
    } else {
      playerListBody.append('<tr><td colspan="3">Tidak ada pemain ditemukan untuk akun ini.</td></tr>');
    }
  }).getPlayersByMatchday();
}



      function updatePlayerStatus(playerId, newStatus) {
      google.script.run.withSuccessHandler(function() {
        // alert('Player status updated successfully!');
        getPlayersByMatchday();
      }).withFailureHandler(function(error) {
        alert('Error: ' + error.message); // Display error message to the user
      }).updatePlayerStatus(playerId, newStatus);
    }




    </script>



   

  </body>
</html>
